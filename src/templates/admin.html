{% extends 'base.html' %}
{% block content %}
<h5 class="mb-3">Admin</h5>

<!-- Category Management -->
<h6 class="admin-section-header admin-section-categories"><i class="fas fa-folder"></i> Categories</h6>
<div class="row mb-3">
    <div class="col-12 col-md-4">
        <div class="card mb-3 admin-card-categories">
            <div class="card-body">
                <h6 class="card-title">Create Category</h6>
                <form action="{{ url_for('create_category') }}" method="post">
                    {{ form.hidden_tag() }}
                    <div class="form-group">
                        <label for="parent-category" class="small">Parent level</label>
                        <select name="parent_category" id="parent-category" class="form-control form-control-sm">
                            <option value="">Root (top level)</option>
                            {% for opt in parent_options %}
                            <option value="{{ opt.path }}">{{ opt.label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="category_name" class="small">Name</label>
                        {{ form.category_name(class="form-control form-control-sm", placeholder="e.g. summer-2024", id="category_name") }}
                    </div>
                    <div id="category-preview" class="small text-muted mb-2"></div>
                    <button type="submit" class="btn btn-primary btn-block btn-sm">
                        <i class="fas fa-plus"></i> Create
                    </button>
                </form>
            </div>
        </div>
    </div>
    <div class="col-12 col-md-8">
        <div class="card mb-3 admin-card-categories">
            <div class="card-body">
                <h6 class="card-title">Categories</h6>
                {% if categories %}
                <div class="category-admin-list">
                    {% for cat in categories %}
                    <div class="category-admin-item d-flex justify-content-between align-items-center" data-category="{{ cat }}">
                        <a href="{{ url_for('category_view', category=cat) }}" class="category-admin-link">{{ cat }}</a>
                        <div class="d-flex align-items-center category-admin-actions">
                            <span class="badge badge-light mr-1 cat-badge" data-cat="{{ cat }}" data-type="photos" title="Photos"><i class="fas fa-image"></i> <span class="cnt"><i class="fas fa-spinner fa-spin" style="font-size:0.55rem"></i></span></span>
                            <span class="badge badge-light mr-2 cat-badge" data-cat="{{ cat }}" data-type="videos" title="Videos"><i class="fas fa-video"></i> <span class="cnt"><i class="fas fa-spinner fa-spin" style="font-size:0.55rem"></i></span></span>
                            <button class="btn btn-outline-secondary btn-sm rename-category-btn mr-1" data-category="{{ cat }}" title="Rename">
                                <i class="fas fa-pen"></i>
                            </button>
                            <button class="btn btn-outline-secondary btn-sm move-category-btn mr-1" data-category="{{ cat }}" title="Move">
                                <i class="fas fa-arrows-alt"></i>
                            </button>
                            <button class="btn btn-outline-danger btn-sm delete-category-btn" data-category="{{ cat }}" title="Delete">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted small mb-0">No categories yet.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Duplicates -->
<h6 class="admin-section-header admin-section-duplicates"><i class="fas fa-clone"></i> Duplicates</h6>
<div class="row mb-3">
    <div class="col-12">
        <div class="card mb-3 admin-card-duplicates">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="card-title mb-0">Find &amp; Review</h6>
                    <button id="scan-dup-btn" class="btn btn-primary btn-sm">
                        <i class="fas fa-search"></i> Scan
                    </button>
                </div>
                <p class="text-muted small mb-2">Find files with the same name and size across categories.</p>
                <div id="dup-log" class="log-box mb-2" style="display:none"></div>
                <div id="dup-status" class="small text-muted mb-2"></div>
                <div id="dup-review" style="display:none">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span id="dup-counter" class="small font-weight-bold"></span>
                        <div>
                            <button id="dup-prev" class="btn btn-outline-secondary btn-sm" disabled><i class="fas fa-chevron-left"></i></button>
                            <button id="dup-next" class="btn btn-outline-secondary btn-sm"><i class="fas fa-chevron-right"></i> Next</button>
                        </div>
                    </div>
                    <div id="dup-file-info" class="small mb-2 font-weight-bold"></div>
                    <div id="dup-locations" class="row"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Rename category dialog -->
<dialog id="rename-category-dialog" class="delete-dialog">
    <form method="dialog">
        <p class="mb-2">Rename category</p>
        <input type="text" id="rename-category-input" class="form-control form-control-sm mb-2" placeholder="New name">
        <div class="dialog-actions">
            <button value="cancel" class="btn btn-sm btn-secondary">Cancel</button>
            <button id="confirm-rename-category" value="default" class="btn btn-sm btn-primary">Rename</button>
        </div>
    </form>
</dialog>

<!-- Delete category confirmation -->
<dialog id="delete-category-dialog" class="delete-dialog">
    <form method="dialog">
        <p id="delete-category-text">Delete this category?</p>
        <div class="dialog-actions">
            <button value="cancel" class="btn btn-sm btn-secondary">Cancel</button>
            <button id="confirm-delete-category" value="default" class="btn btn-sm btn-danger">Delete</button>
        </div>
    </form>
</dialog>

<!-- Move category dialog -->
<dialog id="move-category-dialog" class="delete-dialog">
    <form method="dialog">
        <p class="mb-1">Move category</p>
        <p id="move-category-name" class="small font-weight-bold mb-2"></p>
        <label class="small" for="move-parent-select">New parent</label>
        <select id="move-parent-select" class="form-control form-control-sm mb-2">
            <option value="">Root (top level)</option>
            {% for opt in parent_options %}
            <option value="{{ opt.path }}">{{ opt.label }}</option>
            {% endfor %}
        </select>
        <div id="move-preview" class="small text-muted mb-2"></div>
        <div class="dialog-actions">
            <button value="cancel" class="btn btn-sm btn-secondary">Cancel</button>
            <button id="confirm-move-category" value="default" class="btn btn-sm btn-primary">Move</button>
        </div>
    </form>
</dialog>

<script>
const routes = {
    categoryCounts: "{{ url_for('category_counts_api') }}",
    dupScan: "{{ url_for('scan_duplicates') }}",
    dupDelete: "{{ url_for('delete_duplicate') }}",
};
const deleteCategoryRouteTemplate = "{{ url_for('delete_category', category='CATEGORY_PLACEHOLDER') }}";
const renameCategoryRoute = "{{ url_for('rename_category') }}";
const moveCategoryRoute = "{{ url_for('move_category') }}";

/* ===== Category counts (async, per-album streaming) ===== */
let catCounts = {};
(function() {
    var es = new EventSource(routes.categoryCounts);
    es.onmessage = function(e) {
        var d = JSON.parse(e.data);
        catCounts[d.cat] = {photos: d.photos, videos: d.videos};
        document.querySelectorAll('.cat-badge[data-cat="' + d.cat + '"]').forEach(function(el) {
            var cnt = el.querySelector('.cnt');
            if (cnt) cnt.textContent = d[el.dataset.type] || 0;
        });
    };
    es.onerror = function() {
        es.close();
        document.querySelectorAll('.cnt').forEach(function(el) {
            if (el.querySelector('.fa-spinner')) el.textContent = '?';
        });
    };
})();

/* ===== Category creation preview ===== */
(function() {
    var parentSelect = document.getElementById('parent-category');
    var nameInput = document.getElementById('category_name');
    var preview = document.getElementById('category-preview');
    function updatePreview() {
        var parent = parentSelect.value;
        var name = nameInput.value.trim();
        if (name) {
            var full = parent ? parent + '-' + name : name;
            preview.textContent = 'Will create: ' + full;
        } else {
            preview.textContent = '';
        }
    }
    parentSelect.addEventListener('change', updatePreview);
    nameInput.addEventListener('input', updatePreview);
})();

/* ===== Category delete handling ===== */
(function() {
    const dialog = document.getElementById('delete-category-dialog');
    const dialogText = document.getElementById('delete-category-text');
    const confirmBtn = document.getElementById('confirm-delete-category');
    let pendingCategory = null;

    document.querySelectorAll('.delete-category-btn').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            pendingCategory = this.dataset.category;
            var c = catCounts[pendingCategory] || {photos: 0, videos: 0};
            var info = "Delete category '" + pendingCategory + "'?";
            if (c.photos || c.videos) {
                info += "\n\nContains: " + c.photos + " photo(s), " + c.videos + " video(s).";
            }
            dialogText.textContent = info;
            dialogText.style.whiteSpace = 'pre-line';
            dialog.showModal();
        });
    });

    confirmBtn.addEventListener('click', function() {
        if (!pendingCategory) return;
        const url = deleteCategoryRouteTemplate.replace('CATEGORY_PLACEHOLDER', pendingCategory);
        fetch(url, {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest'},
            body: JSON.stringify({})
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.status === 'success') {
                var item = document.querySelector('.category-admin-item[data-category="' + pendingCategory + '"]');
                if (item) item.remove();
            } else {
                alert(data.message || 'Failed to delete category.');
            }
            dialog.close();
        })
        .catch(function() {
            alert('Error deleting category.');
            dialog.close();
        });
    });
})();

/* ===== Category rename handling ===== */
(function() {
    const dialog = document.getElementById('rename-category-dialog');
    const input = document.getElementById('rename-category-input');
    const confirmBtn = document.getElementById('confirm-rename-category');
    let pendingCategory = null;

    document.querySelectorAll('.rename-category-btn').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            pendingCategory = this.dataset.category;
            input.value = pendingCategory;
            dialog.showModal();
            input.select();
        });
    });

    confirmBtn.addEventListener('click', function() {
        if (!pendingCategory) return;
        var newName = input.value.trim();
        if (!newName || newName === pendingCategory) { dialog.close(); return; }
        confirmBtn.disabled = true;
        confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        fetch(renameCategoryRoute, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({old_name: pendingCategory, new_name: newName})
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.status === 'success') {
                (data.renamed || []).forEach(function(r) {
                    var item = document.querySelector('.category-admin-item[data-category="' + r.old + '"]');
                    if (!item) return;
                    item.dataset.category = r.new;
                    var link = item.querySelector('.category-admin-link');
                    if (link) { link.textContent = r.new; link.href = '/category/' + r.new; }
                    item.querySelectorAll('.cat-badge').forEach(function(b) { b.dataset.cat = r.new; });
                    item.querySelectorAll('.rename-category-btn, .move-category-btn, .delete-category-btn').forEach(function(b) {
                        b.dataset.category = r.new;
                    });
                });
            } else {
                alert(data.message || 'Failed to rename category.');
            }
            confirmBtn.disabled = false;
            confirmBtn.innerHTML = 'Rename';
            dialog.close();
        })
        .catch(function() {
            alert('Error renaming category.');
            confirmBtn.disabled = false;
            confirmBtn.innerHTML = 'Rename';
            dialog.close();
        });
    });
})();

/* ===== Category move handling ===== */
(function() {
    const dialog = document.getElementById('move-category-dialog');
    const nameEl = document.getElementById('move-category-name');
    const parentSelect = document.getElementById('move-parent-select');
    const previewEl = document.getElementById('move-preview');
    const confirmBtn = document.getElementById('confirm-move-category');
    let pendingCategory = null;

    function getLeaf(cat) {
        var parts = cat.split('-');
        return parts[parts.length - 1];
    }

    function filterOptions() {
        var options = parentSelect.querySelectorAll('option');
        options.forEach(function(opt) {
            if (!opt.value) { opt.disabled = false; return; }
            opt.disabled = (opt.value === pendingCategory || opt.value.startsWith(pendingCategory + '-'));
        });
    }

    function updatePreview() {
        if (!pendingCategory) return;
        var parent = parentSelect.value;
        var leaf = getLeaf(pendingCategory);
        var newName = parent ? parent + '-' + leaf : leaf;
        if (newName === pendingCategory) {
            previewEl.textContent = '(no change)';
        } else {
            previewEl.textContent = 'New name: ' + newName;
        }
    }

    document.querySelectorAll('.move-category-btn').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            pendingCategory = this.dataset.category;
            nameEl.textContent = pendingCategory;
            // Reset selection to current parent
            var parts = pendingCategory.split('-');
            parts.pop();
            var currentParent = parts.join('-');
            parentSelect.value = currentParent;
            filterOptions();
            updatePreview();
            dialog.showModal();
        });
    });

    parentSelect.addEventListener('change', updatePreview);

    confirmBtn.addEventListener('click', function() {
        if (!pendingCategory) return;
        var newParent = parentSelect.value;
        var leaf = getLeaf(pendingCategory);
        var newName = newParent ? newParent + '-' + leaf : leaf;
        if (newName === pendingCategory) { dialog.close(); return; }
        confirmBtn.disabled = true;
        confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        fetch(moveCategoryRoute, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({category: pendingCategory, new_parent: newParent})
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.status === 'success') {
                (data.renamed || []).forEach(function(r) {
                    var item = document.querySelector('.category-admin-item[data-category="' + r.old + '"]');
                    if (!item) return;
                    item.dataset.category = r.new;
                    var link = item.querySelector('.category-admin-link');
                    if (link) { link.textContent = r.new; link.href = '/category/' + r.new; }
                    item.querySelectorAll('.cat-badge').forEach(function(b) { b.dataset.cat = r.new; });
                    item.querySelectorAll('.rename-category-btn, .move-category-btn, .delete-category-btn').forEach(function(b) {
                        b.dataset.category = r.new;
                    });
                });
            } else {
                alert(data.message || 'Failed to move category.');
            }
            confirmBtn.disabled = false;
            confirmBtn.innerHTML = 'Move';
            dialog.close();
        })
        .catch(function() {
            alert('Error moving category.');
            confirmBtn.disabled = false;
            confirmBtn.innerHTML = 'Move';
            dialog.close();
        });
    });
})();

/* ===== Duplicates ===== */
(function() {
    var scanBtn = document.getElementById('scan-dup-btn');
    var statusEl = document.getElementById('dup-status');
    var logEl = document.getElementById('dup-log');
    var reviewEl = document.getElementById('dup-review');
    var counterEl = document.getElementById('dup-counter');
    var fileInfoEl = document.getElementById('dup-file-info');
    var locationsEl = document.getElementById('dup-locations');
    var prevBtn = document.getElementById('dup-prev');
    var nextBtn = document.getElementById('dup-next');
    var groups = [];
    var currentIdx = 0;
    var deletedTotal = 0;

    function formatSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    function renderGroup(idx) {
        if (idx < 0 || idx >= groups.length) {
            statusEl.textContent = 'All duplicates reviewed. Deleted ' + deletedTotal + ' file(s).';
            reviewEl.style.display = 'none';
            return;
        }
        currentIdx = idx;
        var g = groups[idx];
        /* skip already-resolved groups (<=1 location left) */
        if (g.locations.length <= 1) {
            if (idx < groups.length - 1) { renderGroup(idx + 1); return; }
            statusEl.textContent = 'All duplicates reviewed. Deleted ' + deletedTotal + ' file(s).';
            reviewEl.style.display = 'none';
            return;
        }
        counterEl.textContent = (idx + 1) + ' of ' + groups.length;
        fileInfoEl.textContent = g.filename + '  (' + formatSize(g.size) + ')';
        prevBtn.disabled = idx === 0;
        nextBtn.disabled = idx === groups.length - 1;

        locationsEl.innerHTML = '';
        g.locations.forEach(function(loc) {
            var col = document.createElement('div');
            col.className = 'col-6 col-md-3 mb-2';
            var card = document.createElement('div');
            card.className = 'card dup-loc-card';

            if (loc.thumbnail) {
                var img = document.createElement('img');
                img.className = 'card-img-top dup-thumb';
                img.src = loc.thumbnail;
                img.alt = g.filename;
                img.onerror = function() { this.outerHTML = '<div class="dup-thumb-placeholder"><i class="fas fa-file fa-2x"></i></div>'; };
                card.appendChild(img);
            } else {
                var ph = document.createElement('div');
                ph.className = 'dup-thumb-placeholder';
                ph.innerHTML = '<i class="fas fa-file fa-2x"></i>';
                card.appendChild(ph);
            }

            var body = document.createElement('div');
            body.className = 'card-body p-2 text-center';
            var catName = document.createElement('div');
            catName.className = 'small font-weight-bold text-truncate';
            catName.textContent = loc.category;
            catName.title = loc.category;

            var delBtn = document.createElement('button');
            delBtn.className = 'btn btn-outline-danger btn-sm mt-1 dup-del-btn';
            delBtn.innerHTML = '<i class="fas fa-trash-alt"></i> Delete';
            delBtn.addEventListener('click', (function(locRef, colRef, btnRef) {
                return function() {
                    btnRef.disabled = true;
                    btnRef.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                    fetch(routes.dupDelete, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({category: locRef.category, filename: g.filename})
                    })
                    .then(function(r) { return r.json(); })
                    .then(function(data) {
                        if (data.status === 'success') {
                            colRef.remove();
                            deletedTotal++;
                            g.locations = g.locations.filter(function(l) { return l.category !== locRef.category; });
                            statusEl.textContent = 'Deleted ' + deletedTotal + ' file(s) so far.';
                            if (g.locations.length <= 1) {
                                /* resolved, auto-advance after brief pause */
                                setTimeout(function() {
                                    if (currentIdx < groups.length - 1) {
                                        renderGroup(currentIdx + 1);
                                    } else {
                                        statusEl.textContent = 'All duplicates reviewed. Deleted ' + deletedTotal + ' file(s).';
                                        reviewEl.style.display = 'none';
                                    }
                                }, 400);
                            }
                        } else {
                            alert(data.message || 'Delete failed.');
                            btnRef.disabled = false;
                            btnRef.innerHTML = '<i class="fas fa-trash-alt"></i> Delete';
                        }
                    })
                    .catch(function() {
                        alert('Error deleting file.');
                        btnRef.disabled = false;
                        btnRef.innerHTML = '<i class="fas fa-trash-alt"></i> Delete';
                    });
                };
            })(loc, col, delBtn));

            body.appendChild(catName);
            body.appendChild(delBtn);
            card.appendChild(body);
            col.appendChild(card);
            locationsEl.appendChild(col);
        });
    }

    scanBtn.addEventListener('click', function() {
        scanBtn.disabled = true;
        scanBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Scanning...';
        logEl.textContent = '';
        logEl.style.display = 'block';
        statusEl.textContent = '';
        reviewEl.style.display = 'none';
        deletedTotal = 0;

        var es = new EventSource(routes.dupScan);
        es.onmessage = function(event) {
            var data = JSON.parse(event.data);
            if (data.type === 'log') {
                logEl.textContent += data.message + '\n';
                logEl.scrollTop = logEl.scrollHeight;
            } else if (data.type === 'done') {
                es.close();
                groups = data.groups || [];
                scanBtn.disabled = false;
                scanBtn.innerHTML = '<i class="fas fa-search"></i> Scan';
                if (groups.length === 0) {
                    statusEl.textContent = 'No duplicates found.';
                } else {
                    statusEl.textContent = 'Found ' + groups.length + ' duplicate group(s). Review below.';
                    reviewEl.style.display = 'block';
                    renderGroup(0);
                }
            }
        };
        es.onerror = function() {
            es.close();
            statusEl.textContent = 'Error scanning.';
            scanBtn.disabled = false;
            scanBtn.innerHTML = '<i class="fas fa-search"></i> Scan';
        };
    });

    prevBtn.addEventListener('click', function() { if (currentIdx > 0) renderGroup(currentIdx - 1); });
    nextBtn.addEventListener('click', function() { if (currentIdx < groups.length - 1) renderGroup(currentIdx + 1); });
})();


</script>
{% endblock %}
