<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <title>Photo Organizer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Bootstrap 4 CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
    <!-- Bootstrap Treeview CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-treeview/1.2.0/bootstrap-treeview.min.css" />
    <!-- PhotoSwipe CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.3/photoswipe.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.3/default-skin/default-skin.min.css" />
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
    <!-- Custom styles -->
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}?v=11">
</head>
<body>
    <nav class="navbar navbar-expand-md">
        <a class="navbar-brand" href="{{ url_for('index') }}">
            <i class="fas fa-home"></i> Home
        </a>
        {% block navbar_extra %}{% endblock %}
        <div class="navbar-right-group ml-auto d-flex align-items-center">
            <div class="zoom-controls">
                <button id="zoom-out" class="btn btn-outline-secondary btn-sm zoom-btn" title="Zoom out"><i class="fas fa-minus"></i></button>
                <button id="zoom-in" class="btn btn-outline-secondary btn-sm zoom-btn" title="Zoom in"><i class="fas fa-plus"></i></button>
            </div>
            <button class="btn btn-sm theme-toggle ml-1" id="theme-toggle" title="Toggle theme">
                <i class="fas fa-sun" id="theme-icon"></i>
            </button>
            <a class="btn btn-sm btn-outline-secondary ml-2" href="{{ url_for('admin_dashboard') }}">
                <i class="fas fa-cog"></i><span class="d-none d-sm-inline ml-1">Admin</span>
            </a>
        </div>
    </nav>

    <div class="container-fluid px-2 px-sm-3 mt-2" id="page-content">
        {% block content %}{% endblock %}
    </div>

    <!-- Floating scroll button -->
    <button class="scroll-fab" id="scroll-fab" title="Scroll to top">
        <i class="fas fa-arrow-up" id="scroll-fab-icon"></i>
    </button>

    <!-- Page loader overlay -->
    <div class="page-loader" id="page-loader">
        <div class="page-loader-content">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2 mb-0">Loading...</p>
        </div>
    </div>

    <!-- jQuery + Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>
    <!-- Bootstrap Treeview -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-treeview/1.2.0/bootstrap-treeview.min.js"></script>
    <!-- PhotoSwipe JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.3/photoswipe.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.3/photoswipe-ui-default.min.js"></script>

    {% block scripts %}{% endblock %}

    <script>
    // Hide the page loader when navigating back via browser history (bfcache)
    window.addEventListener('pageshow', function(event) {
        if (event.persisted) {
            document.getElementById('page-loader').classList.remove('active');
        }
    });
    </script>

    <script>
    (function() {
        var fab = document.getElementById('scroll-fab');
        var fabIcon = document.getElementById('scroll-fab-icon');

        function isAtTop() {
            return window.scrollY < 100;
        }

        function updateFab() {
            if (isAtTop()) {
                fabIcon.className = 'fas fa-arrow-down';
                fab.title = 'Scroll to bottom';
            } else {
                fabIcon.className = 'fas fa-arrow-up';
                fab.title = 'Scroll to top';
            }
        }

        fab.addEventListener('click', function() {
            if (isAtTop()) {
                window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
            } else {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        });

        window.addEventListener('scroll', updateFab, { passive: true });
        updateFab();
    })();
    </script>

    <script>
    (function() {
        const STORAGE_KEY = 'theme-preference';
        const toggle = document.getElementById('theme-toggle');
        const icon = document.getElementById('theme-icon');
        const html = document.documentElement;
        const modes = ['light', 'dark', 'midnight'];
        let current = localStorage.getItem(STORAGE_KEY) || 'light';

        function applyTheme(mode) {
            html.setAttribute('data-theme', mode);
            if (mode === 'light') {
                icon.className = 'fas fa-sun';
                toggle.title = 'Theme: Light';
            } else if (mode === 'dark') {
                icon.className = 'fas fa-moon';
                toggle.title = 'Theme: Dark';
            } else {
                icon.className = 'fas fa-star';
                toggle.title = 'Theme: Midnight';
            }
            localStorage.setItem(STORAGE_KEY, mode);
            current = mode;
        }

        toggle.addEventListener('click', function() {
            const idx = (modes.indexOf(current) + 1) % modes.length;
            applyTheme(modes[idx]);
        });

        applyTheme(current);
    })();
    </script>

    <script>
    (function() {
        var STORAGE_KEY = 'page-zoom';
        var COL_CONFIGS = [
            'col-2 col-sm-2 col-md-1 col-lg-1',
            'col-3 col-sm-2 col-md-2 col-lg-1',
            'col-3 col-sm-3 col-md-2 col-lg-2',
            'col-4 col-sm-3 col-md-3 col-lg-2',
            'col-6 col-sm-4 col-md-3 col-lg-3',
            'col-6 col-sm-6 col-md-4 col-lg-4',
            'col-12 col-sm-6 col-md-6 col-lg-4'
        ];
        var ZOOM_SCALES = [0.5, 0.65, 0.8, 1.0, 1.1, 1.2, 1.25];
        var GRID_GAPS = ['1px', '1px', '2px', '0.2rem', '0.3rem', '0.4rem', '0.5rem'];
        var DEFAULT_IDX = 3;
        var COL_RE = /\bcol(-sm|-md|-lg|-xl)?-\d{1,2}\b/g;
        var idx = parseInt(localStorage.getItem(STORAGE_KEY));
        if (isNaN(idx) || idx < 0 || idx >= COL_CONFIGS.length) idx = DEFAULT_IDX;

        function applyZoom(i) {
            idx = Math.max(0, Math.min(COL_CONFIGS.length - 1, i));
            localStorage.setItem(STORAGE_KEY, idx);
            var scale = ZOOM_SCALES[idx];
            var content = document.getElementById('page-content');

            // Zoom the whole page (like browser zoom)
            document.documentElement.style.zoom = scale;

            // Gallery pages: also change columns + gaps
            var grids = document.querySelectorAll('.gallery-grid');
            grids.forEach(function(grid) {
                grid.style.setProperty('--grid-gap', GRID_GAPS[idx]);
            });
            var items = document.querySelectorAll('.gallery-grid > [class*="col-"]');
            if (items.length > 0) {
                var newClasses = COL_CONFIGS[idx].split(' ');
                items.forEach(function(el) {
                    el.className = el.className.replace(COL_RE, '').replace(/\s+/g, ' ').trim();
                    newClasses.forEach(function(cls) { el.classList.add(cls); });
                });
            }
            document.getElementById('zoom-out').disabled = idx <= 0;
            document.getElementById('zoom-in').disabled = idx >= COL_CONFIGS.length - 1;
        }

        applyZoom(idx);

        document.getElementById('zoom-in').addEventListener('click', function() { applyZoom(idx + 1); });
        document.getElementById('zoom-out').addEventListener('click', function() { applyZoom(idx - 1); });
    })();
    </script>
</body>
</html>
