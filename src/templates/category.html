{% extends 'base.html' %}
{% block content %}
<!-- Category header -->
<div class="category-header d-flex align-items-center flex-wrap mb-2">
    <h5 class="mb-0 mr-2">{{ category }}</h5>
    <a href="{{ url_for('upload_file', category=category) }}" class="btn btn-success btn-sm">
        <i class="fas fa-upload"></i> Upload
    </a>
</div>

<!-- Download buttons row -->
<div class="download-bar mb-2">
    <a href="{{ url_for('download_category', category=category, size='source') }}" class="btn btn-outline-primary btn-sm download-btn" title="Original">
        <i class="fas fa-download"></i> Orig
    </a>
    <a href="{{ url_for('download_category', category=category, size='largest') }}" class="btn btn-outline-info btn-sm download-btn" title="Large">
        <i class="fas fa-download"></i> Large
    </a>
    <a href="{{ url_for('download_category', category=category, size='medium') }}" class="btn btn-outline-secondary btn-sm download-btn" title="Medium">
        <i class="fas fa-download"></i> Med
    </a>
    <a href="{{ url_for('download_videos', category=category) }}" class="btn btn-outline-warning btn-sm download-btn" title="Videos">
        <i class="fas fa-download"></i> Vids
    </a>
    <button id="sort-toggle" class="btn btn-outline-secondary btn-sm" title="Sort by date">
        <i class="fas fa-sort-amount-down" id="sort-icon"></i>
    </button>
    <button id="move-toggle" class="btn btn-outline-secondary btn-sm" title="Move photos">
        <i class="fas fa-arrows-alt"></i> Move
    </button>
</div>

<!-- Move bar (hidden by default) -->
<div id="move-bar" class="move-bar mb-2" style="display:none;">
    <div class="d-flex align-items-center flex-wrap" style="gap:0.4rem;">
        <span class="move-bar-count text-muted" style="font-size:0.8rem;" id="move-count">0 selected</span>
        <button id="select-all" class="btn btn-outline-secondary btn-sm" style="font-size:0.8rem;">
            <i class="fas fa-check-double"></i> All
        </button>
        <button id="deselect-all" class="btn btn-outline-secondary btn-sm" style="font-size:0.8rem;">
            <i class="fas fa-times"></i> None
        </button>
        <select id="move-dest" class="form-control form-control-sm" style="width:auto;max-width:200px;font-size:0.8rem;">
            <option value="">Select album...</option>
            {% for opt in parent_options %}
                {% if opt.path != category %}
                <option value="{{ opt.path }}">{{ opt.label }}</option>
                {% endif %}
            {% endfor %}
        </select>
        <button id="move-confirm" class="btn btn-primary btn-sm" disabled style="font-size:0.8rem;">
            <i class="fas fa-check"></i> Move
        </button>
        <button id="delete-selected" class="btn btn-danger btn-sm" disabled style="font-size:0.8rem;">
            <i class="fas fa-trash-alt"></i> Delete
        </button>
        <button id="move-cancel" class="btn btn-secondary btn-sm" style="font-size:0.8rem;">
            Cancel
        </button>
    </div>
</div>

<!-- Download overlay -->
<div class="download-overlay" id="download-overlay">
    <div class="download-overlay-content">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-2 mb-0" id="download-overlay-text">Preparing download...</p>
    </div>
</div>

<!-- Media Tabs -->
<ul class="nav nav-tabs nav-tabs-compact mb-0" id="mediaTabs" role="tablist">
  <li class="nav-item">
    <a class="nav-link active" id="images-tab" data-toggle="tab" href="#images-pane" role="tab">
      Images <span class="badge badge-light" id="images-count-badge">{{ images|length }}</span>
    </a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="videos-tab" data-toggle="tab" href="#videos-pane" role="tab">
      Videos{% if videos %} <span class="badge badge-light">{{ videos|length }}</span>{% endif %}
    </a>
  </li>
</ul>

<div class="tab-content mt-2">
  <!-- Images Pane -->
  <div class="tab-pane fade show active" id="images-pane" role="tabpanel">
    <div class="row gallery-grid" id="gallery">
      {% for file in images %}
      <div class="col-4 col-sm-3 col-md-3 col-lg-2 gallery-item-col" data-date="{{ file.meta.get('date', '') }}" data-filename="{{ file.filename }}">
        <div class="card media-card">
          <a href="{{ url_for('uploaded_file', filename=category + '/largest/' + file.filename) }}"
             data-pswp-title="{{ file.filename }}"
             data-pswp-width="{{ file.width }}"
             data-pswp-height="{{ file.height }}"
             data-pswp-meta='{{ file.meta | tojson }}'
             class="gallery-item">
              <div class="thumb-container loading">
                <img src="{{ url_for('uploaded_file', filename=category + '/thumbnail/' + file.name + '.jpeg') }}"
                     class="card-img-top"
                     alt="{{ file.filename }}"
                     loading="lazy"
                     decoding="async"
                     onload="this.closest('.thumb-container')?.classList.remove('loading')"
                     onerror="this.closest('.thumb-container')?.classList.remove('loading'); this.src='{{ url_for('static', filename='placeholder.jpg') }}'">
                <div class="thumb-spinner spinner-border spinner-border-sm text-secondary" role="status" aria-hidden="true"></div>
                {% if file.meta.get('date') %}
                <span class="photo-date-badge">{{ file.meta.date[:10] | replace(":", "-") }}</span>
                {% endif %}
              </div>
          </a>
          <input type="checkbox" class="move-checkbox" data-filename="{{ file.filename }}" style="display:none;">
          <div class="card-actions">
            <div class="btn-group btn-group-sm" role="group">
              <a href="{{ url_for('download_single', category=category, size='source', filename=file.filename) }}" class="btn btn-outline-primary btn-xs" download title="Source">L</a>
              <a href="{{ url_for('download_single', category=category, size='largest', filename=file.filename) }}" class="btn btn-outline-info btn-xs" download title="Large">M</a>
              <a href="{{ url_for('download_single', category=category, size='medium', filename=file.filename) }}" class="btn btn-outline-secondary btn-xs" download title="Medium">S</a>
            </div>
            <form action="{{ url_for('delete_photo', category=category, filename=file.filename) }}" method="post" class="mb-0 delete-form" data-filename="{{ file.filename }}">
              <button type="submit" class="btn btn-outline-danger btn-xs" title="Delete"><i class="fas fa-trash-alt"></i></button>
            </form>
          </div>
        </div>
      </div>
      {% else %}
      <p class="px-3 text-muted">No images in this category.</p>
      {% endfor %}
    </div>
  </div>

  <!-- Videos Pane -->
  <div class="tab-pane fade" id="videos-pane" role="tabpanel">
    <div class="row gallery-grid" id="videos-grid">
      {% for video in videos %}
      <div class="col-4 col-sm-3 col-md-3 col-lg-2">
        <div class="card media-card">
          <div class="thumb-container loading video-poster" data-video-src="{{ url_for('uploaded_file', filename=category + '/source/' + video.filename) }}">
            <img src="{{ video.poster }}"
                 class="card-img-top"
                 alt="{{ video.filename }}"
                 loading="lazy"
                 decoding="async"
                 onload="this.closest('.thumb-container')?.classList.remove('loading')"
                 onerror="this.closest('.thumb-container')?.classList.remove('loading'); this.src='{{ url_for('static', filename='placeholder.jpg') }}'">
            <div class="thumb-spinner spinner-border spinner-border-sm text-secondary" role="status" aria-hidden="true"></div>
            <div class="play-overlay"><i class="fas fa-play"></i></div>
          </div>
          <div class="card-actions">
            <a href="{{ url_for('download_single', category=category, size='source', filename=video.filename) }}" class="btn btn-outline-primary btn-xs" download title="Download"><i class="fas fa-download"></i></a>
            <form action="{{ url_for('delete_photo', category=category, filename=video.filename) }}" method="post" class="mb-0 delete-form" data-filename="{{ video.filename }}">
              <button type="submit" class="btn btn-outline-danger btn-xs" title="Delete"><i class="fas fa-trash-alt"></i></button>
            </form>
          </div>
        </div>
      </div>
      {% else %}
      <p class="px-3 text-muted">No videos in this category.</p>
      {% endfor %}
    </div>
  </div>
</div>
</div>

<!-- PhotoSwipe Container -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="pswp__bg"></div>
    <div class="pswp__scroll-wrap">
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>
        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
                <div class="pswp__counter"></div>
            </div>
            <div class="pswp__button pswp__button--arrow--left" title="Previous"></div>
            <div class="pswp__button pswp__button--arrow--right" title="Next"></div>
            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>

<!-- Delete confirmation dialog -->
<dialog id="delete-confirmation-dialog" class="delete-dialog">
    <form method="dialog">
        <p id="dialog-text">Are you sure you want to delete this item?</p>
        <div class="dialog-actions">
            <button value="cancel" class="btn btn-sm btn-secondary">Cancel</button>
            <button id="confirm-delete" value="default" class="btn btn-sm btn-danger">Delete</button>
        </div>
    </form>
</dialog>

<!-- Bulk delete confirmation dialog -->
<dialog id="bulk-delete-dialog" class="delete-dialog">
    <form method="dialog">
        <p id="bulk-delete-text">Are you sure you want to delete the selected photos?</p>
        <div class="dialog-actions">
            <button value="cancel" class="btn btn-sm btn-secondary">Cancel</button>
            <button id="confirm-bulk-delete" value="default" class="btn btn-sm btn-danger">Delete</button>
        </div>
    </form>
</dialog>

<script>
document.addEventListener('DOMContentLoaded', function() {
    var CATEGORY = {{ category | tojson }};
    var deleteForms = document.querySelectorAll('.delete-form');
    var dialog = document.getElementById('delete-confirmation-dialog');
    var dialogText = document.getElementById('dialog-text');
    var confirmDeleteButton = document.getElementById('confirm-delete');
    var currentForm = null;

    // ===== PhotoSwipe setup =====
    var pswpElement = document.querySelectorAll('.pswp')[0];
    var uiElement = PhotoSwipeUI_Default;
    var galleryLinks = document.querySelectorAll('.gallery-item');
    var items = [];

    galleryLinks.forEach(function(link) {
        var src = link.getAttribute('href');
        var title = link.getAttribute('data-pswp-title');
        var width = parseInt(link.getAttribute('data-pswp-width')) || 1024;
        var height = parseInt(link.getAttribute('data-pswp-height')) || 768;

        var metaHtml = '';
        try {
            var meta = JSON.parse(link.getAttribute('data-pswp-meta') || '{}');
            var parts = [];
            if (meta.camera) parts.push(meta.camera);
            if (meta.date) parts.push(meta.date);
            if (meta.aperture) parts.push(meta.aperture);
            if (meta.shutter) parts.push(meta.shutter);
            if (meta.iso) parts.push('ISO ' + meta.iso);
            if (meta.focal_length) parts.push(meta.focal_length);
            if (parts.length) {
                metaHtml = '<br><small style="opacity:0.7">' + parts.join(' &middot; ') + '</small>';
            }
            if (meta.gps) {
                metaHtml += ' <a href="https://maps.google.com/?q=' + meta.gps.lat + ',' + meta.gps.lon + '" target="_blank" rel="noopener" style="color:#8cf;font-size:0.8em"><i class="fas fa-map-marker-alt"></i> Map</a>';
            }
        } catch(e) {}

        items.push({
            src: src,
            w: width,
            h: height,
            title: title + metaHtml
        });
    });

    galleryLinks.forEach(function(link, index) {
        link.addEventListener('click', function(e) {
            if (moveMode) return e.preventDefault();
            e.preventDefault();
            var gallery = new PhotoSwipe(pswpElement, uiElement, items, {
                index: index,
                bgOpacity: 0.9,
                showHideOpacity: true,
                preload: [1,1]
            });
            gallery.init();
        });
    });

    // ===== Delete handling =====
    deleteForms.forEach(function(form) {
        form.addEventListener('submit', function(event) {
            event.preventDefault();
            currentForm = this;
            dialogText.textContent = "Delete '" + this.dataset.filename + "'?";
            dialog.showModal();
        });
    });

    confirmDeleteButton.addEventListener('click', function() {
        if (!currentForm) return;
        fetch(currentForm.action, {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest'},
            body: JSON.stringify({})
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.status === 'success') {
                var card = currentForm.closest('.card').parentElement;
                card.remove();
                updateImageCount();
            } else {
                alert(data.message);
            }
            dialog.close();
        })
        .catch(function() {
            alert('Error deleting file.');
            dialog.close();
        });
    });

    // Handle cached images
    document.querySelectorAll('.thumb-container img').forEach(function(img){
        if (img.complete) {
            img.closest('.thumb-container')?.classList.remove('loading');
        }
    });

    // ===== Download overlay with fetch =====
    var overlay = document.getElementById('download-overlay');
    var overlayText = document.getElementById('download-overlay-text');
    document.querySelectorAll('.download-btn').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            var url = btn.href;
            var label = btn.title.toLowerCase();
            overlayText.textContent = 'Preparing ' + label + ' download...';
            overlay.classList.add('active');

            fetch(url)
                .then(function(resp) {
                    if (!resp.ok) throw new Error('Download failed');
                    var disposition = resp.headers.get('Content-Disposition') || '';
                    var match = disposition.match(/filename="?([^";\n]+)"?/);
                    var filename = match ? match[1] : label + '.zip';
                    return resp.blob().then(function(blob) { return { blob: blob, filename: filename }; });
                })
                .then(function(result) {
                    var a = document.createElement('a');
                    a.href = URL.createObjectURL(result.blob);
                    a.download = result.filename;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    URL.revokeObjectURL(a.href);
                    overlay.classList.remove('active');
                })
                .catch(function() {
                    overlayText.textContent = 'Download failed.';
                    setTimeout(function() { overlay.classList.remove('active'); }, 2000);
                });
        });
    });

    // ===== Video poster -> player =====
    document.querySelectorAll('.video-poster').forEach(function(container) {
        container.addEventListener('click', function() {
            var src = container.getAttribute('data-video-src');
            if (!src) return;
            var video = document.createElement('video');
            video.className = 'card-img-top';
            video.controls = true;
            video.preload = 'metadata';
            video.playsInline = true;
            var source = document.createElement('source');
            source.src = src;
            video.appendChild(source);
            container.replaceWith(video);
        });
    });

    // ===== Sort toggle =====
    var sortDesc = true; // default: newest first
    var sortBtn = document.getElementById('sort-toggle');
    var sortIcon = document.getElementById('sort-icon');

    sortBtn.addEventListener('click', function() {
        sortDesc = !sortDesc;
        sortIcon.className = sortDesc ? 'fas fa-sort-amount-down' : 'fas fa-sort-amount-up';
        sortBtn.title = sortDesc ? 'Newest first' : 'Oldest first';

        var gallery = document.getElementById('gallery');
        var cols = Array.from(gallery.querySelectorAll('.gallery-item-col'));
        if (!cols.length) return;

        cols.sort(function(a, b) {
            var da = a.getAttribute('data-date') || '';
            var db = b.getAttribute('data-date') || '';
            if (!da && !db) return 0;
            if (!da) return 1;
            if (!db) return -1;
            return sortDesc ? db.localeCompare(da) : da.localeCompare(db);
        });

        cols.forEach(function(col) { gallery.appendChild(col); });

        // Rebuild PhotoSwipe items after reorder
        items.length = 0;
        document.querySelectorAll('.gallery-item').forEach(function(link) {
            var src = link.getAttribute('href');
            var title = link.getAttribute('data-pswp-title');
            var width = parseInt(link.getAttribute('data-pswp-width')) || 1024;
            var height = parseInt(link.getAttribute('data-pswp-height')) || 768;
            var metaHtml = '';
            try {
                var meta = JSON.parse(link.getAttribute('data-pswp-meta') || '{}');
                var parts = [];
                if (meta.camera) parts.push(meta.camera);
                if (meta.date) parts.push(meta.date);
                if (meta.aperture) parts.push(meta.aperture);
                if (meta.shutter) parts.push(meta.shutter);
                if (meta.iso) parts.push('ISO ' + meta.iso);
                if (meta.focal_length) parts.push(meta.focal_length);
                if (parts.length) metaHtml = '<br><small style="opacity:0.7">' + parts.join(' &middot; ') + '</small>';
                if (meta.gps) metaHtml += ' <a href="https://maps.google.com/?q=' + meta.gps.lat + ',' + meta.gps.lon + '" target="_blank" rel="noopener" style="color:#8cf;font-size:0.8em"><i class="fas fa-map-marker-alt"></i> Map</a>';
            } catch(e) {}
            items.push({ src: src, w: width, h: height, title: title + metaHtml });
        });

        // Re-bind click events
        document.querySelectorAll('.gallery-item').forEach(function(link, index) {
            var newLink = link.cloneNode(true);
            link.parentNode.replaceChild(newLink, link);
            newLink.addEventListener('click', function(e) {
                if (moveMode) return e.preventDefault();
                e.preventDefault();
                var gallery = new PhotoSwipe(pswpElement, uiElement, items, {
                    index: index, bgOpacity: 0.9, showHideOpacity: true, preload: [1,1]
                });
                gallery.init();
            });
        });
    });

    // ===== Move photos =====
    var moveMode = false;
    var moveToggle = document.getElementById('move-toggle');
    var moveBar = document.getElementById('move-bar');
    var moveCount = document.getElementById('move-count');
    var moveDest = document.getElementById('move-dest');
    var moveConfirm = document.getElementById('move-confirm');
    var moveCancel = document.getElementById('move-cancel');

    var deleteSelected = document.getElementById('delete-selected');

    function updateImageCount() {
        var count = document.querySelectorAll('#gallery .gallery-item-col').length;
        var badge = document.getElementById('images-count-badge');
        if (badge) badge.textContent = count;
    }

    function updateMoveCount() {
        var checked = document.querySelectorAll('.move-checkbox:checked').length;
        moveCount.textContent = checked + ' selected';
        moveConfirm.disabled = checked === 0 || !moveDest.value;
        deleteSelected.disabled = checked === 0;
        document.querySelectorAll('.move-checkbox').forEach(function(cb) {
            var col = cb.closest('.gallery-item-col');
            if (col) col.classList.toggle('move-selected', cb.checked);
        });
    }

    function enterMoveMode() {
        moveMode = true;
        moveBar.style.display = '';
        moveToggle.classList.add('active');
        document.querySelectorAll('.move-checkbox').forEach(function(cb) {
            cb.style.display = '';
            cb.checked = false;
        });
        document.querySelectorAll('.gallery-item-col').forEach(function(col) {
            col.classList.add('move-mode');
        });
        updateMoveCount();
    }

    function exitMoveMode() {
        moveMode = false;
        moveBar.style.display = 'none';
        moveToggle.classList.remove('active');
        document.querySelectorAll('.move-checkbox').forEach(function(cb) {
            cb.style.display = 'none';
            cb.checked = false;
        });
        document.querySelectorAll('.gallery-item-col').forEach(function(col) {
            col.classList.remove('move-mode');
        });
        moveDest.value = '';
    }

    moveToggle.addEventListener('click', function() {
        if (moveMode) exitMoveMode();
        else enterMoveMode();
    });

    moveCancel.addEventListener('click', function() { exitMoveMode(); });
    moveDest.addEventListener('change', updateMoveCount);

    // Click on card toggles checkbox in move mode
    document.querySelectorAll('.gallery-item-col').forEach(function(col) {
        col.addEventListener('click', function(e) {
            if (!moveMode) return;
            if (e.target.closest('.card-actions') || e.target.closest('.move-checkbox')) return;
            var cb = col.querySelector('.move-checkbox');
            if (cb) {
                cb.checked = !cb.checked;
                updateMoveCount();
            }
        });
    });

    document.querySelectorAll('.move-checkbox').forEach(function(cb) {
        cb.addEventListener('change', updateMoveCount);
    });

    moveConfirm.addEventListener('click', function() {
        var dest = moveDest.value;
        if (!dest) return;
        var selected = [];
        document.querySelectorAll('.move-checkbox:checked').forEach(function(cb) {
            selected.push(cb.getAttribute('data-filename'));
        });
        if (!selected.length) return;
        var total = selected.length;
        moveConfirm.disabled = true;
        moveConfirm.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 0/' + total;

        fetch('/photos/move', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                source_category: CATEGORY,
                dest_category: dest,
                filenames: selected
            })
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.status === 'success' || data.status === 'partial') {
                var moved = data.moved || [];
                moved.forEach(function(fname, i) {
                    var col = document.querySelector('.gallery-item-col[data-filename="' + fname + '"]');
                    if (col) col.remove();
                    moveConfirm.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ' + (i + 1) + '/' + total;
                });
                updateImageCount();
                exitMoveMode();
            } else {
                alert(data.message || 'Move failed.');
            }
            moveConfirm.disabled = false;
            moveConfirm.innerHTML = '<i class="fas fa-check"></i> Move';
        })
        .catch(function() {
            alert('Error moving photos.');
            moveConfirm.disabled = false;
            moveConfirm.innerHTML = '<i class="fas fa-check"></i> Move';
        });
    });

    // ===== Select All / Deselect All =====
    document.getElementById('select-all').addEventListener('click', function() {
        document.querySelectorAll('.move-checkbox').forEach(function(cb) { cb.checked = true; });
        updateMoveCount();
    });
    document.getElementById('deselect-all').addEventListener('click', function() {
        document.querySelectorAll('.move-checkbox').forEach(function(cb) { cb.checked = false; });
        updateMoveCount();
    });

    // ===== Bulk Delete =====
    var bulkDeleteDialog = document.getElementById('bulk-delete-dialog');
    var bulkDeleteText = document.getElementById('bulk-delete-text');
    var confirmBulkDelete = document.getElementById('confirm-bulk-delete');

    deleteSelected.addEventListener('click', function() {
        var checked = document.querySelectorAll('.move-checkbox:checked').length;
        if (!checked) return;
        bulkDeleteText.textContent = 'Delete ' + checked + ' selected photo(s)? This cannot be undone.';
        bulkDeleteDialog.showModal();
    });

    confirmBulkDelete.addEventListener('click', function() {
        var selected = [];
        document.querySelectorAll('.move-checkbox:checked').forEach(function(cb) {
            selected.push(cb.getAttribute('data-filename'));
        });
        if (!selected.length) return;
        var total = selected.length;
        deleteSelected.disabled = true;
        deleteSelected.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 0/' + total;
        bulkDeleteDialog.close();

        fetch('/photos/delete', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                category: CATEGORY,
                filenames: selected
            })
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.status === 'success' || data.status === 'partial') {
                var deleted = data.deleted || [];
                deleted.forEach(function(fname, i) {
                    var col = document.querySelector('.gallery-item-col[data-filename="' + fname + '"]');
                    if (col) col.remove();
                    deleteSelected.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ' + (i + 1) + '/' + total;
                });
                updateImageCount();
                updateMoveCount();
            } else {
                alert(data.message || 'Delete failed.');
            }
            deleteSelected.disabled = false;
            deleteSelected.innerHTML = '<i class="fas fa-trash-alt"></i> Delete';
        })
        .catch(function() {
            alert('Error deleting photos.');
            deleteSelected.disabled = false;
            deleteSelected.innerHTML = '<i class="fas fa-trash-alt"></i> Delete';
            bulkDeleteDialog.close();
        });
    });

    // ===== Mobile Drag-to-Select =====
    (function() {
        var gallery = document.getElementById('gallery');
        var dragging = false;
        var dragAction = null; // 'select' or 'deselect'
        var startX = 0, startY = 0;
        var directionLocked = false; // true once we decide horizontal vs vertical
        var isHorizontal = false;    // true = drag-to-select, false = scroll
        var toggled = new Set();

        gallery.addEventListener('touchstart', function(e) {
            if (!moveMode) return;
            if (e.touches.length !== 1) return;
            var touch = e.touches[0];
            startX = touch.clientX;
            startY = touch.clientY;
            dragging = true;
            directionLocked = false;
            isHorizontal = false;
            toggled.clear();

            // Determine action from first card under finger
            var el = document.elementFromPoint(touch.clientX, touch.clientY);
            if (el) {
                var col = el.closest('.gallery-item-col');
                if (col) {
                    var cb = col.querySelector('.move-checkbox');
                    if (cb) {
                        dragAction = cb.checked ? 'deselect' : 'select';
                    }
                }
            }
        }, {passive: true});

        gallery.addEventListener('touchmove', function(e) {
            if (!dragging || !moveMode) return;
            var touch = e.touches[0];
            if (!directionLocked) {
                var dx = Math.abs(touch.clientX - startX);
                var dy = Math.abs(touch.clientY - startY);
                // Wait for enough movement to determine direction
                if (dx < 10 && dy < 10) return;
                directionLocked = true;
                isHorizontal = dx > dy;
                if (!isHorizontal) {
                    // Vertical drag — let the browser scroll normally
                    dragging = false;
                    return;
                }
            }
            // Horizontal drag — do drag-to-select, suppress scroll
            e.preventDefault();
            var el = document.elementFromPoint(touch.clientX, touch.clientY);
            if (!el) return;
            var col = el.closest('.gallery-item-col');
            if (!col) return;
            var fname = col.getAttribute('data-filename');
            if (!fname || toggled.has(fname)) return;
            toggled.add(fname);
            var cb = col.querySelector('.move-checkbox');
            if (cb) {
                cb.checked = (dragAction === 'select');
                updateMoveCount();
            }
        }, {passive: false});

        gallery.addEventListener('touchend', function() {
            dragging = false;
            dragAction = null;
            directionLocked = false;
            isHorizontal = false;
            toggled.clear();
        });

        gallery.addEventListener('touchcancel', function() {
            dragging = false;
            dragAction = null;
            directionLocked = false;
            isHorizontal = false;
            toggled.clear();
        });
    })();
});
</script>
{% endblock %}
