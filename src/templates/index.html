{% extends 'base.html' %}
{% block content %}
<div class="d-flex align-items-center justify-content-between mb-1">
    <div></div>
    <div class="tree-controls">
        <button class="btn btn-outline-secondary btn-sm tree-ctrl-btn" id="expand-all" title="Expand all">
            <i class="fas fa-plus-square"></i>
        </button>
        <button class="btn btn-outline-secondary btn-sm tree-ctrl-btn" id="collapse-all" title="Collapse all">
            <i class="fas fa-minus-square"></i>
        </button>
    </div>
</div>
<div class="tree-container">
    <div id="category-tree"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function(){
    var treeData = {{ treeData|tojson }};
    var STORAGE_KEY = 'tree-expanded';
    var saving = true;

    // Load/save expanded state
    function getSavedExpanded() {
        try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; }
        catch(e) { return []; }
    }
    function saveExpanded(list) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
    }

    // Add "Open" button to parent nodes (only if real category exists)
    function prepareNodes(nodes) {
        nodes.forEach(function(node) {
            if (node.nodes && node.nodes.length > 0) {
                var openBtn = '';
                if (node.isRealCategory) {
                    openBtn = ' <a href="' + node.href + '" class="btn btn-outline-primary btn-xs tree-open-btn" data-href="' + node.href + '">Open</a>';
                }
                node.text = '<span class="tree-node-text">' + node.text + '</span>' + openBtn;
                node.selectable = true;
                prepareNodes(node.nodes);
            } else {
                node.text = '<span class="tree-node-text">' + node.text + '</span>';
                node.selectable = true;
            }
        });
    }
    prepareNodes(treeData);

    var $tree = $('#category-tree');

    // Init tree collapsed, we expand saved nodes after
    saving = false;
    $tree.treeview({
        data: treeData,
        enableHtml: true,
        enableLinks: false,
        showBorder: false,
        expandIcon: 'fas fa-chevron-right',
        collapseIcon: 'fas fa-chevron-down',
        nodeIcon: 'fas fa-folder',
        levels: 1,
        onNodeSelected: function(event, node) {
            if (node.nodes && node.nodes.length > 0) {
                // Parent node: toggle expand/collapse
                $tree.treeview('toggleNodeExpanded', [node.nodeId]);
                $tree.treeview('unselectNode', [node.nodeId, { silent: true }]);
            } else {
                // Leaf node: navigate with loader
                document.getElementById('page-loader').classList.add('active');
                window.location.href = node.href;
            }
        },
        onNodeExpanded: function(event, node) {
            if (!saving) return;
            var list = getSavedExpanded();
            if (list.indexOf(node.href) === -1) list.push(node.href);
            saveExpanded(list);
        },
        onNodeCollapsed: function(event, node) {
            if (!saving) return;
            var list = getSavedExpanded();
            var idx = list.indexOf(node.href);
            if (idx !== -1) list.splice(idx, 1);
            saveExpanded(list);
        }
    });

    // Restore saved expanded state after init
    var savedExpanded = getSavedExpanded();
    if (savedExpanded.length > 0) {
        // Collapse everything first (levels:1 may have expanded root)
        $tree.treeview('collapseAll', { silent: true });

        // Find and expand saved nodes
        var allNodes = $tree.treeview('getEnabled');
        allNodes.forEach(function(node) {
            if (node.href && savedExpanded.indexOf(node.href) !== -1) {
                $tree.treeview('expandNode', [node.nodeId, { silent: true }]);
            }
        });
    }
    saving = true;

    // Handle "Open" button clicks on parent nodes
    $tree.on('click', '.tree-open-btn', function(e) {
        e.preventDefault();
        e.stopPropagation();
        document.getElementById('page-loader').classList.add('active');
        window.location.href = $(this).data('href');
    });

    // Expand all / Collapse all
    $('#expand-all').on('click', function() {
        $tree.treeview('expandAll', { silent: true });
        // Save all parent hrefs
        var allNodes = $tree.treeview('getEnabled');
        var list = [];
        allNodes.forEach(function(node) {
            if (node.nodes && node.nodes.length > 0 && node.href) {
                list.push(node.href);
            }
        });
        saveExpanded(list);
    });

    $('#collapse-all').on('click', function() {
        $tree.treeview('collapseAll', { silent: true });
        saveExpanded([]);
    });
});
</script>
{% endblock %}
